# ==================== REDIS CONFIGURATION FOR LIVE CHAT ====================
# Production-ready Redis setup for TikTok-style live streaming chat

# Redis Connection
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# Redis Pool Settings (for high concurrency)
REDIS_POOL_SIZE=100
REDIS_MIN_IDLE_CONNS=10
REDIS_MAX_RETRIES=3
REDIS_DIAL_TIMEOUT=5s
REDIS_READ_TIMEOUT=3s
REDIS_WRITE_TIMEOUT=3s
REDIS_POOL_TIMEOUT=4s

# ==================== REDIS INSTALLATION ====================

# macOS (Homebrew)
# brew install redis
# brew services start redis

# Ubuntu/Debian
# sudo apt update
# sudo apt install redis-server
# sudo systemctl start redis
# sudo systemctl enable redis

# Docker
# docker run -d --name redis -p 6379:6379 redis:7-alpine

# ==================== REDIS CONFIGURATION (redis.conf) ====================

# For production, create/edit /etc/redis/redis.conf or /usr/local/etc/redis.conf

# Bind to all interfaces (change in production for security)
bind 0.0.0.0

# Set password (IMPORTANT for production)
# requirepass your-strong-redis-password-here

# Max memory (adjust based on your server)
maxmemory 2gb
maxmemory-policy allkeys-lru

# Persistence (for message history)
save 900 1
save 300 10
save 60 10000

# AOF persistence (more durable)
appendonly yes
appendfsync everysec

# Max clients
maxclients 10000

# Timeout (0 = never timeout)
timeout 300

# TCP keepalive
tcp-keepalive 60

# Logging
loglevel notice
logfile /var/log/redis/redis-server.log

# ==================== REDIS STREAMS CONFIGURATION ====================

# Stream max length (trim old messages)
# This is set per-stream in the application code
# Example: XADD live:123:history MAXLEN ~ 10000 * field value

# ==================== REDIS PUB/SUB CONFIGURATION ====================

# Pub/Sub has no special configuration needed
# Channels are created on-demand when first published to

# ==================== MONITORING & HEALTH CHECKS ====================

# Check Redis status
# redis-cli ping
# Expected: PONG

# Monitor live connections
# redis-cli CLIENT LIST

# Monitor memory usage
# redis-cli INFO memory

# Monitor pub/sub channels
# redis-cli PUBSUB CHANNELS

# Monitor streams
# redis-cli XINFO STREAM live:123:history

# ==================== REDIS KEYS USED BY LIVE CHAT ====================

# Viewer count
# Key: live:{stream_id}:viewers
# Type: String (integer)
# TTL: 24 hours
# Commands: INCR, DECR, GET

# Sequence number
# Key: live:{stream_id}:seq
# Type: String (integer)
# TTL: 24 hours
# Commands: INCR

# Message history (Redis Stream)
# Key: live:{stream_id}:history
# Type: Stream
# TTL: 24 hours
# Commands: XADD, XRANGE, XREAD

# Pinned message
# Key: live:{stream_id}:pinned
# Type: String (JSON)
# TTL: 24 hours
# Commands: SET, GET

# Pub/Sub channel
# Channel: live:{stream_id}
# Type: Pub/Sub
# Commands: PUBLISH, SUBSCRIBE

# ==================== REDIS CLUSTER (for 10k+ concurrent streams) ====================

# For massive scale, use Redis Cluster
# Minimum 6 nodes (3 masters + 3 replicas)

# redis.conf for cluster mode:
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 5000

# Create cluster:
# redis-cli --cluster create \
#   127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
#   127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 \
#   --cluster-replicas 1

# ==================== REDIS SENTINEL (for high availability) ====================

# For automatic failover, use Redis Sentinel
# sentinel.conf:
# sentinel monitor mymaster 127.0.0.1 6379 2
# sentinel down-after-milliseconds mymaster 5000
# sentinel parallel-syncs mymaster 1
# sentinel failover-timeout mymaster 10000

# ==================== PERFORMANCE TUNING ====================

# Disable transparent huge pages (THP)
# echo never > /sys/kernel/mm/transparent_hugepage/enabled

# Increase max open files
# ulimit -n 65535

# TCP backlog
# echo 511 > /proc/sys/net/core/somaxconn

# Overcommit memory
# echo 1 > /proc/sys/vm/overcommit_memory

# ==================== SECURITY ====================

# 1. Set strong password
# requirepass your-strong-password-here

# 2. Disable dangerous commands
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""

# 3. Use firewall to restrict access
# ufw allow from 10.0.0.0/8 to any port 6379

# 4. Use TLS/SSL (Redis 6+)
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt

# ==================== BACKUP & RESTORE ====================

# Manual backup
# redis-cli BGSAVE

# Restore from RDB
# cp dump.rdb /var/lib/redis/
# sudo systemctl restart redis

# Restore from AOF
# cp appendonly.aof /var/lib/redis/
# sudo systemctl restart redis

# ==================== EXAMPLE USAGE IN GO ====================

# Initialize Redis in main.go:
# 
# import (
#     "lomi-backend/internal/handlers"
#     "github.com/redis/go-redis/v9"
# )
# 
# func main() {
#     // Initialize Redis
#     if err := handlers.InitRedis(
#         os.Getenv("REDIS_HOST") + ":" + os.Getenv("REDIS_PORT"),
#         os.Getenv("REDIS_PASSWORD"),
#         0, // DB number
#     ); err != nil {
#         log.Fatalf("Failed to connect to Redis: %v", err)
#     }
#     
#     // ... rest of your app setup
# }
