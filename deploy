#!/bin/bash

# Simple One-Command Deployment
# Usage: ./deploy [commit message]
# 
# This will:
# 1. Commit all changes
# 2. Push to GitHub
# 3. Server auto-deploys (if webhook is set up)

set -e

COMMIT_MSG="${1:-Deploy: $(date +'%Y-%m-%d %H:%M:%S')}"

echo "ğŸš€ Deploying to production..."
echo "ğŸ“ Message: $COMMIT_MSG"
echo ""

# Check if git is initialized
if [ ! -d .git ]; then
    echo "ğŸ“¦ Initializing git..."
    git init
    git remote add origin https://github.com/yohannesjx/lomi_mini.git 2>/dev/null || true
fi

# Stage all changes
echo "ğŸ“¦ Staging changes..."
git add .

# Check if there are changes
if [ -z "$(git status --porcelain)" ]; then
    echo "â„¹ï¸  No changes to commit"
else
    echo "ğŸ’¾ Committing..."
    git commit -m "$COMMIT_MSG" || true
fi

# Get current branch
BRANCH=$(git branch --show-current 2>/dev/null || echo "main")

# Push to GitHub
echo "ğŸ“¤ Pushing to GitHub..."
git push -u origin $BRANCH 2>/dev/null || git push origin $BRANCH

echo ""
echo "âœ… Code pushed to GitHub!"
echo ""
echo "â³ Server will auto-deploy (if webhook is set up)"
echo ""
echo "ğŸ“Š Check status on server:"
echo "   ssh user@152.53.87.200 'cd /opt/lomi_mini && docker-compose -f docker-compose.prod.yml ps'"

